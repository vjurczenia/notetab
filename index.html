<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Notetab</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%221em%22 font-size=%2280%22>üìù</text></svg>">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
  <style>
    html,body {
      height: 100%;
      margin: 0;
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial;
    }
    #editor {
      height: 100%;
    }
    #preview {
      border-top: 1px solid transparent;
      padding-left: 30px;
      padding-bottom: 1px;
      font-size: clamp(22px, 3vw, 28px);
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    #toggle {
      position: fixed;
      bottom: 25px;
      right: 30px;
      color: black;
    }
    #toggle svg {
      width: 60px;
    }
  </style>
</head>
<body>
  <div id="editor" style="display: none"></div>
  <div id="preview" style="display: block"></div>
  <div id="toggle" style="display: none" title="Toggle between editor and preview (Ctrl/Cmd-Shift-E)">
    <!-- https://heroicons.com/ -->
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
    </svg>
  </div>
  
  <!-- Marked.js markdown rendering from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked-highlight/lib/index.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>

  <!-- Monaco loader from CDN -->
  <script src="https://unpkg.com/monaco-editor@0.39.0/min/vs/loader.js"></script>
  <script>
    // Get local storage key
    const defaultNoteKey = "notetab";
    const noteKey = window.location.search.substring(1) || defaultNoteKey;
    document.title = noteKey;

    // Render markdown
    const { markedHighlight } = window.markedHighlight;

    const markedWithHighlight = new marked.Marked(
      markedHighlight({
        langPrefix: 'hljs language-',
        highlight(code, lang) {
          if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
          }
          return hljs.highlightAuto(code).value;
        }
      })
    );

    const elPreview = document.getElementById('preview');

    function renderMarkdown(markdown) {
      const raw = markedWithHighlight.parse(markdown);
      const clean = DOMPurify.sanitize(raw, { USE_PROFILES: { html: true } });
      elPreview.innerHTML = clean;
    }

    // Display README on first use
    if (noteKey == defaultNoteKey && localStorage.getItem(noteKey) === null) {
      let readme = '';

      fetch('https://raw.githubusercontent.com/vjurczenia/notetab/refs/heads/main/README.md')
        .then(response => {
          if (!response.ok) {
            throw new Error();
          }
          return response.text();
        })
        .then(text => {
          readme = text;
        })
        .catch(() => {
          readme = '';
        })
        .finally(() => {
          localStorage.setItem(noteKey, readme);
        });
    }

    if (localStorage.getItem(noteKey)) renderMarkdown(localStorage.getItem(noteKey));

    // Tell Monaco where its "vs" folder is located (CDN path)
    // Also configure workers so Monaco can load them from the CDN when used from a file:// or simple server.
    window.MonacoEnvironment = {
      getWorkerUrl: function(workerId, label) {
        return 'data:text/javascript;charset=utf-8,' + encodeURIComponent(
          "self.MonacoEnvironment = { baseUrl: 'https://unpkg.com/monaco-editor@0.39.0/min/' }; importScripts('https://unpkg.com/monaco-editor@0.39.0/min/vs/base/worker/workerMain.js');"
        );
      }
    };

    require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.39.0/min/vs' } });
    require(['vs/editor/editor.main'], function() {
      const elEditor = document.getElementById('editor');

      const editor = monaco.editor.create(elEditor, {
        value: localStorage.getItem(noteKey),
        language: 'markdown',
        automaticLayout: true,
        minimap: { enabled: false },
        wordWrap: "on",
        quickSuggestions: false,
        cursorStyle: "block-outline"
      });

      function show(element) {
        [elEditor, elPreview].forEach(el => el.style.display = 'none');
        if (element === elPreview) renderMarkdown(editor.getValue());
        element.style.display = 'block';
        if (element === elEditor) editor.focus();
      }
      
      if (localStorage.getItem(noteKey)) {
        // On startup, if there's an existing file:
        //   - set the cursor position at the end of the file
        //   - display the last line in the middle of the screen
        // Note: editor element has to be visible for this
        show(elEditor);
        const model = editor.getModel();
        const lastLine = model.getLineCount();
        const lastColumn = model.getLineMaxColumn(lastLine);
        editor.setPosition({ lineNumber: lastLine, column: lastColumn });
        editor.layout();
        editor.revealPositionInCenterIfOutsideViewport({ lineNumber: lastLine, column: lastColumn });
        show(elPreview);
      } else show(elEditor);

      // Handle visibility of editor and preview
      let editorBlurred = false;
      window.addEventListener('blur', () => {
        if (elEditor.style.display !== 'none') {
          editorBlurred = true;
          show(elPreview);
        }
      });

      window.addEventListener('focus', () => {
        if (editorBlurred) {
          editorBlurred = false;
          show(elEditor);
        }
      });

      function toggle() {
        if (elEditor.style.display === 'none') show(elEditor);
        else show(elPreview);
      }

      const elToggle = document.getElementById('toggle');
      elToggle.style.display = 'block';
      elToggle.addEventListener('click', toggle)

      // Write contents to local storage
      editor.onDidChangeModelContent(() => {
        localStorage.setItem(noteKey, editor.getValue());
      });

      window.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
          // Override Ctrl+S (Cmd+S on Mac) to save content instead of the page
          e.preventDefault();
          const content = editor.getValue();
          const blob = new Blob([content], { type: 'text/markdown' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = noteKey + '.md';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } else if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'e') {
          toggle();
        }
      });

      // Handle links
      const insertMarkdownLinkCommand = editor.addCommand(
        monaco.KeyMod.chord(
          monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyK,
          monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyK
        ),
        () => {
          const model = editor.getModel();
          const edits = editor.getSelections()
            .slice()
            .reverse()
            .map(sel => {
              const text = model.getValueInRange(sel);
              const linkText = text ? `[${text}]()` : `[link]()`;
              return { range: sel, text: linkText, forceMoveMarkers: true };
            });
          editor.executeEdits(null, edits);

          const newSelections = editor
            .getSelections()
            .map(sel => {
              return new monaco.Selection(
                sel.startLineNumber,
                sel.startColumn - 1,
                sel.startLineNumber,
                sel.startColumn - 1
              );
            })
          editor.setSelections(newSelections);
        });

      // Expose editor for debugging from the console
      window._monacoEditor = editor;
    });
  </script>
</body>
</html>
